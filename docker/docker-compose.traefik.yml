# ============================================================================
# Cordys CRM - Traefik 反向代理配置（覆盖文件）
# 
# 适用场景：
#   - 生产环境使用 Traefik 作为反向代理
#   - 需要 HTTPS/SSL 终结
#   - 与其他服务共享 Traefik 实例
#
# 前置条件：
#   - Traefik 已部署并运行
#   - traefik-public 网络已创建
#   - DNS 已配置指向服务器
#   - SSL 证书已配置（Let's Encrypt 或自签名）
#
# 使用方法：
#   # 1. 创建 Traefik 网络（如果不存在）
#   docker network create traefik-public
#
#   # 2. 配置环境变量
#   cp env.external.template .env
#   vim .env  # 设置 TRAEFIK_DOMAIN 等
#
#   # 3. 启动服务
#   docker compose -f docker-compose.external.yml -f docker-compose.traefik.yml up -d
#
# 注意：
#   - 此配置不包含 nginx
#   - 使用 Traefik 作为唯一的反向代理
#   - 支持自动 HTTPS（需要 Traefik 配置 Let's Encrypt）
# ============================================================================

services:
  cordys-crm:
    # 使用 Traefik 时不直接暴露端口
    ports: !reset []
    
    # Traefik 标签配置
    labels:
      # 启用 Traefik
      - "traefik.enable=true"
      
      # ========================================
      # Web 应用路由（主服务 :8081）
      # ========================================
      - "traefik.http.routers.cordys-web.rule=Host(`${TRAEFIK_DOMAIN:-crm.example.com}`)"
      - "traefik.http.routers.cordys-web.entrypoints=websecure"
      - "traefik.http.routers.cordys-web.tls=true"
      - "traefik.http.routers.cordys-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.cordys-web.service=cordys-web-svc"
      - "traefik.http.services.cordys-web-svc.loadbalancer.server.port=8081"
      
      # HTTP 自动跳转 HTTPS
      - "traefik.http.routers.cordys-web-http.rule=Host(`${TRAEFIK_DOMAIN:-crm.example.com}`)"
      - "traefik.http.routers.cordys-web-http.entrypoints=web"
      - "traefik.http.routers.cordys-web-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
      
      # ========================================
      # MCP Server 路由（AI 智能体 :8082）
      # 可选：如果需要外部访问 MCP Server
      # ========================================
      - "traefik.http.routers.cordys-mcp.rule=Host(`${TRAEFIK_DOMAIN:-crm.example.com}`) && PathPrefix(`/mcp`)"
      - "traefik.http.routers.cordys-mcp.entrypoints=websecure"
      - "traefik.http.routers.cordys-mcp.tls=true"
      - "traefik.http.routers.cordys-mcp.service=cordys-mcp-svc"
      - "traefik.http.services.cordys-mcp-svc.loadbalancer.server.port=8082"
      
      # ========================================
      # 安全中间件
      # ========================================
      # 安全响应头
      - "traefik.http.middlewares.cordys-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cordys-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cordys-security.headers.stsPreload=true"
      - "traefik.http.middlewares.cordys-security.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.cordys-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.cordys-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.cordys-security.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.cordys-security.headers.frameDeny=true"
      
      # 应用安全中间件
      - "traefik.http.routers.cordys-web.middlewares=cordys-security"
      
      # ========================================
      # 限流配置（可选，防止滥用）
      # ========================================
      # - "traefik.http.middlewares.cordys-ratelimit.ratelimit.average=100"
      # - "traefik.http.middlewares.cordys-ratelimit.ratelimit.burst=50"
      # - "traefik.http.middlewares.cordys-ratelimit.ratelimit.period=1s"
    
    # 加入 Traefik 网络
    networks:
      - cordys-network
      - traefik-public

# ============================================================
# 网络配置
# ============================================================
networks:
  cordys-network:
    driver: bridge
  
  # Traefik 公共网络（需提前创建）
  traefik-public:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik-public}

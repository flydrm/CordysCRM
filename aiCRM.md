# Cordys CRM AI é©±åŠ¨èƒ½åŠ›å…¨æ™¯

## ğŸ“‹ æ¦‚è¿°

**Cordys CRM** ä½œä¸ºæ–°ä¸€ä»£ AI é©±åŠ¨çš„ CRM ç³»ç»Ÿï¼Œæ·±åº¦æ•´åˆäº†å¤šé¡¹ AI èƒ½åŠ›ï¼Œå®ç°ä»ä¼ ç»Ÿå®¢æˆ·ç®¡ç†å‘æ™ºèƒ½åŒ–é”€å”®è¿è¥çš„è·¨è¶Šã€‚æœ¬æ–‡æ¡£è¯¦ç»†æ¢³ç†äº†å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ AI ç›¸å…³åŠŸèƒ½æ¨¡å—ã€‚

---

## ğŸ¤– AI èƒ½åŠ›æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cordys CRM AI èƒ½åŠ›å±‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   MaxKB      â”‚  â”‚   SQLBot     â”‚  â”‚     DataEase         â”‚   â”‚
â”‚  â”‚  æ™ºèƒ½ä½“å¹³å°   â”‚  â”‚  æ™ºèƒ½é—®æ•°    â”‚  â”‚   BI å¯è§†åŒ–åˆ†æ       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                      â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ™ºèƒ½åˆ›å»º     â”‚  â”‚ è‡ªç„¶è¯­è¨€æŸ¥è¯¢ â”‚  â”‚   é”€å”®æ•°æ®å¯è§†åŒ–      â”‚   â”‚
â”‚  â”‚ æ™ºèƒ½å½•å…¥     â”‚  â”‚ æ•°æ®åº“ç»“æ„   â”‚  â”‚   è‡ªåŠ©åˆ†æ            â”‚   â”‚
â”‚  â”‚ æ™ºèƒ½è·Ÿè¿›     â”‚  â”‚ æƒé™è¿‡æ»¤     â”‚  â”‚   å½’å› åˆ†æ            â”‚   â”‚
â”‚  â”‚ æ™ºèƒ½æŠ¥ä»·     â”‚  â”‚ æ•°æ®å®‰å…¨     â”‚  â”‚   åµŒå…¥å¼çœ‹æ¿          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         MCP Server å¼€æ”¾åè®®                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸€ã€MaxKB æ™ºèƒ½ä½“é›†æˆ

### åŠŸèƒ½å®šä½
MaxKB æ˜¯é£è‡´äº‘å‡ºå“çš„ä¼ä¸šçº§æ™ºèƒ½ä½“å¼€å‘å¹³å°ï¼ŒCordys CRM æ·±åº¦é›†æˆ MaxKBï¼Œå®ç°æ™ºèƒ½åŒ–é”€å”®æ“ä½œã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æè¿° | åº”ç”¨åœºæ™¯ |
|----------|------|----------|
| **æ™ºèƒ½åˆ›å»º** | é€šè¿‡å¯¹è¯æ–¹å¼åˆ›å»ºçº¿ç´¢/å®¢æˆ·/å•†æœº/è”ç³»äºº | é”€å”®äººå‘˜å¿«é€Ÿå½•å…¥ä¿¡æ¯ |
| **æ™ºèƒ½å½•å…¥** | AI è¾…åŠ©å¡«å†™è·Ÿè¿›è®°å½• | è‡ªåŠ¨æå–é€šè¯/ä¼šè®®è¦ç‚¹ |
| **æ™ºèƒ½æŸ¥é‡** | è‡ªåŠ¨è¯†åˆ«é‡å¤å®¢æˆ·/çº¿ç´¢ | æ•°æ®æ¸…æ´—ä¸åˆå¹¶ |
| **æ™ºèƒ½è·Ÿè¿›** | åŸºäºå†å²æ•°æ®æ¨èè·Ÿè¿›ç­–ç•¥ | é”€å”®ç­–ç•¥ä¼˜åŒ– |
| **æ™ºèƒ½æŠ¥ä»·** | è‡ªåŠ¨ç”ŸæˆæŠ¥ä»·å• | å¿«é€Ÿå“åº”å®¢æˆ·éœ€æ±‚ |

### æŠ€æœ¯å®ç°

**åç«¯ä»£ç è·¯å¾„**: `backend/crm/src/main/java/cn/cordys/crm/integration/agent/`

#### æ ¸å¿ƒæœåŠ¡ç±»

```java
// AgentBaseService.java - æ™ºèƒ½ä½“æ ¸å¿ƒæœåŠ¡
@Service
public class AgentBaseService {
    // æ·»åŠ æ™ºèƒ½ä½“
    public Agent addAgent(AgentAddRequest request, String orgId, String userId);
    
    // è·å–å·¥ä½œç©ºé—´åˆ—è¡¨
    public List<OptionDTO> workspace(String orgId);
    
    // è·å–åº”ç”¨åˆ—è¡¨
    public List<OptionDTO> application(String workspaceId, String orgId);
    
    // è·å–åµŒå…¥è„šæœ¬ä¿¡æ¯
    public ScriptResponse script(ScriptRequest request, String orgId);
}
```

#### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/agent/add` | POST | æ·»åŠ æ™ºèƒ½ä½“ |
| `/agent/update` | POST | æ›´æ–°æ™ºèƒ½ä½“ |
| `/agent/detail/{id}` | GET | æ™ºèƒ½ä½“è¯¦æƒ… |
| `/agent/page` | POST | æ™ºèƒ½ä½“åˆ—è¡¨ |
| `/agent/workspace` | GET | è·å–MaxKBå·¥ä½œç©ºé—´ |
| `/agent/application/{workspaceId}` | GET | è·å–åº”ç”¨åˆ—è¡¨ |
| `/agent/script` | POST | è·å–åµŒå…¥è„šæœ¬ |
| `/agent/edition` | GET | è·å–MaxKBç‰ˆæœ¬(PE/EE) |

#### MaxKB API è·¯å¾„

```java
// MaxKBApiPaths.java
public interface MaxKBApiPaths {
    String WORKSPACE = "/admin/api/workspace";              // å·¥ä½œç©ºé—´
    String EDITION = "/admin/api/profile";                   // ç‰ˆæœ¬ä¿¡æ¯
    String APPLICATION = "/admin/api/workspace/{0}/application";  // åº”ç”¨åˆ—è¡¨
    String ACCESS_TOKEN = "/admin/api/workspace/{0}/application/{1}/access_token";  // è®¿é—®ä»¤ç‰Œ
    String APPLICATION_DETAIL = "/admin/api/workspace/{0}/application/{1}";         // åº”ç”¨è¯¦æƒ…
}
```

### é…ç½®å‚æ•°

| å‚æ•° | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `mkAddress` | MaxKB æœåŠ¡åœ°å€ | `https://maxkb.example.com` |
| `appSecret` | åº”ç”¨å¯†é’¥ | `xxx-xxx-xxx` |
| `workspaceId` | å·¥ä½œç©ºé—´ ID | `ws-001` |
| `applicationId` | åº”ç”¨ ID | `app-001` |

### æ™ºèƒ½ä½“æ•°æ®æ¨¡å‹

```java
// Agent.java
@Table(name = "agent")
public class Agent extends BaseModel {
    private String name;           // æ™ºèƒ½ä½“åç§°
    private String agentModuleId;  // æ¨¡å—ID
    private String organizationId; // ç»„ç»‡ID
    private String scopeId;        // åº”ç”¨èŒƒå›´(JSON)
    private String script;         // åµŒå…¥è„šæœ¬
    private String description;    // æè¿°
    private String type;           // æ·»åŠ æ–¹å¼
    private String workspaceId;    // MaxKBå·¥ä½œç©ºé—´ID
    private String applicationId;  // MaxKBåº”ç”¨ID
}
```

---

## ğŸ“Š äºŒã€SQLBot æ™ºèƒ½é—®æ•°

### åŠŸèƒ½å®šä½
SQLBot æ˜¯åŸºäºå¤§æ¨¡å‹å’Œ RAG çš„æ™ºèƒ½é—®æ•°ç³»ç»Ÿï¼Œå…è®¸ç”¨æˆ·ä½¿ç”¨è‡ªç„¶è¯­è¨€æŸ¥è¯¢ CRM æ•°æ®ã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | æŠ€æœ¯å®ç° |
|------|------|----------|
| **è‡ªç„¶è¯­è¨€æŸ¥è¯¢** | ç”¨ä¸­æ–‡æé—®è·å–æ•°æ® | LLM + Text-to-SQL |
| **æ•°æ®åº“ç»“æ„è§£æ** | è‡ªåŠ¨è§£æè¡¨ç»“æ„ä¾›AIä½¿ç”¨ | å…ƒæ•°æ®æå– |
| **æƒé™è¿‡æ»¤** | æŒ‰ç”¨æˆ·æƒé™è¿‡æ»¤å¯æŸ¥è¯¢çš„è¡¨ | åŠ¨æ€SQLæ³¨å…¥ |
| **æ•°æ®è„±æ•** | æ•æ„Ÿæ•°æ®åŠ å¯†ä¼ è¾“ | AES-CBCåŠ å¯† |
| **è™šæ‹Ÿè¡¨æ”¯æŒ** | æ”¯æŒå…¬æµ·æ± /çº¿ç´¢æ± ç­‰è™šæ‹Ÿè¡¨ | è§†å›¾æ˜ å°„ |

### æŠ€æœ¯å®ç°

**åç«¯ä»£ç è·¯å¾„**: `backend/crm/src/main/java/cn/cordys/crm/integration/sqlbot/`

#### æ”¯æŒçš„ä¸šåŠ¡è¡¨

```java
// SQLBotTable.java - æ”¯æŒçš„è¡¨æšä¸¾
public enum SQLBotTable {
    PRODUCT("product", "äº§å“è¡¨", null, false),
    CUSTOMER("customer", "å®¢æˆ·è¡¨", CUSTOMER_MANAGEMENT_READ, true),
    CLUE("clue", "çº¿ç´¢è¡¨", CLUE_MANAGEMENT_READ, true),
    OPPORTUNITY("opportunity", "å•†æœºè¡¨", OPPORTUNITY_MANAGEMENT_READ, true),
    CONTACT("customer_contact", "è”ç³»äººè¡¨", CUSTOMER_MANAGEMENT_CONTACT_READ, true),
    
    // è™šæ‹Ÿè¡¨
    POOL_CUSTOMER("pool_customer", "å…¬æµ·ä¸­çš„å®¢æˆ·è¡¨", CUSTOMER_MANAGEMENT_POOL_READ, true),
    POOL_CLUE("pool_clue", "çº¿ç´¢æ± ä¸­çš„çº¿ç´¢è¡¨", CLUE_MANAGEMENT_POOL_READ, true);
}
```

#### æ ¸å¿ƒæœåŠ¡

```java
// DataSourceService.java
@Service
public class DataSourceService {
    // è·å–æ•°æ®åº“ç»“æ„(ä¾›SQLBotä½¿ç”¨)
    public SQLBotDTO getDatabaseSchema(String userId, String orgId);
    
    // è·å–è¡¨åˆ—è¡¨(å¸¦ç¼“å­˜)
    @Cacheable(value = "table_schema_cache", key = "#databaseName")
    public List<TableDTO> tableList(String databaseName);
}
```

#### æƒé™å¤„ç†å™¨

ç³»ç»Ÿä¸ºæ¯ç§ä¸šåŠ¡è¡¨å®ç°äº†ä¸“é—¨çš„æƒé™å¤„ç†å™¨ï¼š

| å¤„ç†å™¨ | ä¸šåŠ¡è¡¨ | åŠŸèƒ½ |
|--------|--------|------|
| `CustomerPermissionHandler` | customer | å®¢æˆ·æ•°æ®æƒé™è¿‡æ»¤ |
| `CluePermissionHandler` | clue | çº¿ç´¢æ•°æ®æƒé™è¿‡æ»¤ |
| `OpportunityPermissionHandler` | opportunity | å•†æœºæ•°æ®æƒé™è¿‡æ»¤ |
| `ContactPermissionHandler` | customer_contact | è”ç³»äººæ•°æ®æƒé™è¿‡æ»¤ |
| `PoolCustomerPermissionHandler` | pool_customer | å…¬æµ·å®¢æˆ·æƒé™è¿‡æ»¤ |
| `PoolCluePermissionHandler` | pool_clue | çº¿ç´¢æ± æƒé™è¿‡æ»¤ |
| `ProductPermissionHandler` | product | äº§å“æ•°æ®æƒé™è¿‡æ»¤ |

#### å­—æ®µè§£æå™¨

æ”¯æŒå¤šç§å­—æ®µç±»å‹çš„æ™ºèƒ½è§£æï¼š

```
field/
â”œâ”€â”€ InputParser.java          # æ–‡æœ¬è¾“å…¥
â”œâ”€â”€ SelectParser.java         # å•é€‰ä¸‹æ‹‰
â”œâ”€â”€ SelectMultipleParser.java # å¤šé€‰ä¸‹æ‹‰
â”œâ”€â”€ DateTimeParser.java       # æ—¥æœŸæ—¶é—´
â”œâ”€â”€ MemberParser.java         # äººå‘˜é€‰æ‹©
â”œâ”€â”€ DepartmentParser.java     # éƒ¨é—¨é€‰æ‹©
â”œâ”€â”€ PhoneParser.java          # ç”µè¯å·ç 
â”œâ”€â”€ RadioParser.java          # å•é€‰æ¡†
â”œâ”€â”€ CheckboxParser.java       # å¤é€‰æ¡†
â”œâ”€â”€ TextareaParser.java       # å¤šè¡Œæ–‡æœ¬
â””â”€â”€ SerialNumberParser.java   # æµæ°´å·
```

#### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/db/structure` | GET | è·å–æ•°æ®åº“ç»“æ„(SQLBotä¸“ç”¨) |

### é…ç½®å‚æ•°

```yaml
sqlbot:
  encrypt: true                    # æ˜¯å¦å¯ç”¨åŠ å¯†
  aes-key: ${random.value}         # AESåŠ å¯†å¯†é’¥
  aes-iv: ${random.value}          # AESåˆå§‹å‘é‡
  datasource:
    username: ${spring.datasource.username}
    password: ${spring.datasource.password}
```

---

## ğŸ“ˆ ä¸‰ã€DataEase BI é›†æˆ

### åŠŸèƒ½å®šä½
DataEase æ˜¯å¼€æº BI å·¥å…·ï¼ŒCordys CRM é›†æˆ DataEase å®ç°é”€å”®æ•°æ®çš„å¯è§†åŒ–åˆ†æã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | åº”ç”¨åœºæ™¯ |
|------|------|----------|
| **åµŒå…¥å¼çœ‹æ¿** | å°† DataEase çœ‹æ¿åµŒå…¥ CRM | é”€å”®ç®¡ç†é©¾é©¶èˆ± |
| **JWT å•ç‚¹ç™»å½•** | è‡ªåŠ¨è®¤è¯æ— éœ€äºŒæ¬¡ç™»å½• | æ— ç¼ç”¨æˆ·ä½“éªŒ |
| **æ•°æ®æƒé™åŒæ­¥** | CRM æƒé™æ˜ å°„åˆ° DataEase | æ•°æ®å®‰å…¨ |
| **ç”¨æˆ·åŒæ­¥** | è‡ªåŠ¨åŒæ­¥ CRM ç”¨æˆ·åˆ° DataEase | ç»Ÿä¸€ç®¡ç† |

### æŠ€æœ¯å®ç°

**åç«¯ä»£ç è·¯å¾„**: `backend/crm/src/main/java/cn/cordys/crm/integration/dataease/`

#### æ ¸å¿ƒæœåŠ¡

```java
// DataEaseService.java
@Service
public class DataEaseService {
    // è·å–åµŒå…¥å¼DE-Token
    public DeAuthDTO getEmbeddedDeToken(String organizationId, String userId, boolean isModule);
    
    // è·å–DataEaseé…ç½®
    public ThirdConfigurationDTO getDeConfig(String organizationId);
    
    // ç”ŸæˆJWT Token
    private String generateJwtToken(String appId, String appSecret, String account);
}
```

#### æ•°æ®æƒé™å˜é‡

```java
// æ•°æ®èŒƒå›´å˜é‡
public enum DataScopeVariable {
    CURRENT_USER_ID,      // å½“å‰ç”¨æˆ·ID
    CURRENT_ORG_ID,       // å½“å‰ç»„ç»‡ID
    CURRENT_DEPT_ID,      // å½“å‰éƒ¨é—¨ID
}

// éƒ¨é—¨æ•°æ®èŒƒå›´å˜é‡
public enum DataScopeDeptVariable {
    DEPT_IDS,             // éƒ¨é—¨IDåˆ—è¡¨
    ALL_DATA,             // å…¨éƒ¨æ•°æ®
}
```

#### åŒæ­¥æœåŠ¡

```java
// DataEaseSyncService.java - æ•°æ®åŒæ­¥æœåŠ¡
@Service
public class DataEaseSyncService {
    // åŒæ­¥ç”¨æˆ·åˆ°DataEase
    // åŒæ­¥è§’è‰²åˆ°DataEase
    // åŒæ­¥æƒé™åˆ°DataEase
}
```

---

## ğŸ” å››ã€æ™ºèƒ½æœç´¢ç³»ç»Ÿ

### åŠŸèƒ½å®šä½
æä¾›è·¨æ¨¡å—çš„ç»Ÿä¸€æ™ºèƒ½æœç´¢ï¼Œæ”¯æŒå…¨å±€æœç´¢å’Œé«˜çº§æŸ¥é‡æœç´¢ã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½æ¨¡å— | æè¿° | åº”ç”¨åœºæ™¯ |
|----------|------|----------|
| **å…¨å±€æœç´¢** | è·¨æ¨¡å—ç»Ÿä¸€æœç´¢ | å¿«é€Ÿå®šä½å®¢æˆ·/å•†æœº |
| **é«˜çº§æœç´¢** | ç²¾ç¡®æ¡ä»¶ç­›é€‰ | å¤æ‚æŸ¥è¯¢éœ€æ±‚ |
| **æ™ºèƒ½æŸ¥é‡** | è¯†åˆ«é‡å¤æ•°æ® | æ•°æ®æ¸…æ´— |
| **ç›¸ä¼¼åŒ¹é…** | æŸ¥æ‰¾ç›¸ä¼¼å®¢æˆ·/å•†æœº | æ•°æ®åˆå¹¶ |

### æŠ€æœ¯å®ç°

**åç«¯ä»£ç è·¯å¾„**: `backend/crm/src/main/java/cn/cordys/crm/search/`

#### æ¨¡å—ç»“æ„

```
search/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ GlobalSearchController.java      # å…¨å±€æœç´¢æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ AdvancedSearchController.java    # é«˜çº§æœç´¢æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ SearchFieldMaskConfigController.java  # æœç´¢å­—æ®µæ©ç é…ç½®
â”‚   â””â”€â”€ UserSearchConfigController.java  # ç”¨æˆ·æœç´¢é…ç½®
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ global/                          # å…¨å±€æœç´¢æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ GlobalCustomerSearchService.java
â”‚   â”‚   â”œâ”€â”€ GlobalClueSearchService.java
â”‚   â”‚   â”œâ”€â”€ GlobalOpportunitySearchService.java
â”‚   â”‚   â”œâ”€â”€ GlobalCustomerContactSearchService.java
â”‚   â”‚   â”œâ”€â”€ GlobalCustomerPoolSearchService.java
â”‚   â”‚   â”œâ”€â”€ GlobalCluePoolSearchService.java
â”‚   â”‚   â””â”€â”€ GlobalSearchCountService.java
â”‚   â””â”€â”€ advanced/                        # é«˜çº§æœç´¢æœåŠ¡
â”‚       â”œâ”€â”€ AdvancedCustomerSearchService.java
â”‚       â”œâ”€â”€ AdvancedClueSearchService.java
â”‚       â”œâ”€â”€ AdvancedOpportunitySearchService.java
â”‚       â””â”€â”€ AdvancedSearchServiceFactory.java
```

#### å…¨å±€æœç´¢ API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/global/search/account` | POST | æœç´¢å®¢æˆ· |
| `/global/search/lead` | POST | æœç´¢çº¿ç´¢ |
| `/global/search/opportunity` | POST | æœç´¢å•†æœº |
| `/global/search/contact` | POST | æœç´¢è”ç³»äºº |
| `/global/search/customer_pool` | POST | æœç´¢å…¬æµ·å®¢æˆ· |
| `/global/search/clue_pool` | POST | æœç´¢çº¿ç´¢æ±  |
| `/global/search/module/count` | POST | æ¨¡å—æ•°é‡ç»Ÿè®¡ |

#### æœç´¢æ¨¡å—æšä¸¾

```java
// SearchModuleEnum.java
public enum SearchModuleEnum {
    CUSTOMER,           // å®¢æˆ·
    CUSTOMER_CONTACT,   // è”ç³»äºº
    CLUE,              // çº¿ç´¢
    OPPORTUNITY,       // å•†æœº
    CUSTOMER_POOL,     // å…¬æµ·
    CLUE_POOL          // çº¿ç´¢æ± 
}
```

---

## ğŸ”— äº”ã€MCP Server å¼€æ”¾åè®®

### åŠŸèƒ½å®šä½
MCP (Model Context Protocol) æ˜¯ Cordys CRM å¼€æ”¾çš„ AI æ¥å£åè®®ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ AI ç³»ç»Ÿå¯¹æ¥ CRMã€‚

### æ”¯æŒçš„æ“ä½œ

| æ“ä½œç±»å‹ | æ”¯æŒæ¨¡å— | æè¿° |
|----------|----------|------|
| **æ™ºèƒ½åˆ›å»º** | çº¿ç´¢ã€å®¢æˆ·ã€å•†æœºã€è”ç³»äºº | AI å¯¹è¯åˆ›å»ºä¸šåŠ¡æ•°æ® |
| **æ™ºèƒ½å½•å…¥** | è·Ÿè¿›è®°å½• | è‡ªåŠ¨æå–ä¼šè®®çºªè¦ |
| **æ™ºèƒ½æŸ¥é‡** | å®¢æˆ·ã€çº¿ç´¢ | è¯†åˆ«é‡å¤æ•°æ® |

### æ¥å£æ–‡æ¡£

**æ–‡æ¡£è·¯å¾„**: `installer/mcp/mcp.md`

---

## âš™ï¸ å…­ã€è‡ªåŠ¨åŒ–è§„åˆ™å¼•æ“

### åŠŸèƒ½å®šä½
åŸºäºè§„åˆ™çš„è‡ªåŠ¨åŒ–å¤„ç†ï¼Œå‡å°‘äººå·¥æ“ä½œã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | åº”ç”¨åœºæ™¯ |
|------|------|----------|
| **å•†æœºè‡ªåŠ¨å…³é—­** | è¶…æœŸæœªè·Ÿè¿›è‡ªåŠ¨å…³é—­ | å•†æœºç®¡ç†ä¼˜åŒ– |
| **çº¿ç´¢è‡ªåŠ¨å›æ”¶** | è¶…æœŸçº¿ç´¢å›æ”¶åˆ°çº¿ç´¢æ±  | çº¿ç´¢æ± ç®¡ç† |
| **å®¢æˆ·è‡ªåŠ¨å›æ”¶** | è¶…æœŸå®¢æˆ·ç§»å…¥å…¬æµ· | å…¬æµ·æœºåˆ¶ |
| **å®šæ—¶ä»»åŠ¡è°ƒåº¦** | è§„åˆ™å®šæ—¶æ‰§è¡Œ | è‡ªåŠ¨åŒ–è¿è¥ |

### æŠ€æœ¯å®ç°

```java
// OpportunityRuleListener.java - å•†æœºè§„åˆ™ç›‘å¬å™¨
@Component
public class OpportunityRuleListener implements ApplicationListener<ScheduleExecuteEvent> {
    // æ ¹æ®é¢„è®¾è§„åˆ™è‡ªåŠ¨å¤„ç†å•†æœºçŠ¶æ€
    // å½“è§¦å‘æ‰§è¡Œäº‹ä»¶æ—¶ï¼Œæ£€æŸ¥æ‰€æœ‰ç›¸å…³å•†æœº
    // æ ¹æ®è§„åˆ™æ¡ä»¶è‡ªåŠ¨å…³é—­ç¬¦åˆæ¡ä»¶çš„å•†æœº
}
```

---

## ğŸ”Œ ä¸ƒã€ç¬¬ä¸‰æ–¹å¹³å°é›†æˆ

### ä¼ä¸šåä½œå¹³å°

| å¹³å° | åŠŸèƒ½ | ä»£ç è·¯å¾„ |
|------|------|----------|
| **ä¼ä¸šå¾®ä¿¡** | æ¶ˆæ¯é€šçŸ¥ã€ç”¨æˆ·åŒæ­¥ã€æ‰«ç ç™»å½• | `integration/wecom/` |
| **é’‰é’‰** | æ¶ˆæ¯é€šçŸ¥ã€ç»„ç»‡æ¶æ„åŒæ­¥ | `integration/dingtalk/` |
| **é£ä¹¦** | æ¶ˆæ¯é€šçŸ¥ã€ç”¨æˆ·åŒæ­¥ | `integration/lark/` |

### SSO å•ç‚¹ç™»å½•

```java
// SSOService.java - å•ç‚¹ç™»å½•æœåŠ¡
@Service
public class SSOService {
    // ç»Ÿä¸€èº«ä»½è®¤è¯
    // Token ç®¡ç†
    // OAuth é›†æˆ
}
```

---

## ğŸ“ å…«ã€ä»£ç ç»“æ„æ€»è§ˆ

```
backend/crm/src/main/java/cn/cordys/crm/integration/
â”œâ”€â”€ agent/                    # MaxKB æ™ºèƒ½ä½“é›†æˆ
â”‚   â”œâ”€â”€ constant/            # MaxKB API è·¯å¾„å¸¸é‡
â”‚   â”œâ”€â”€ controller/          # æ™ºèƒ½ä½“æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ domain/              # æ™ºèƒ½ä½“å®ä½“
â”‚   â”œâ”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ mapper/              # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ response/            # MaxKB å“åº”æ¨¡å‹
â”‚   â””â”€â”€ service/             # æ™ºèƒ½ä½“æœåŠ¡
â”œâ”€â”€ sqlbot/                   # SQLBot æ™ºèƒ½é—®æ•°
â”‚   â”œâ”€â”€ constant/            # è¡¨æšä¸¾å®šä¹‰
â”‚   â”œâ”€â”€ controller/          # æ•°æ®æºæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ handler/             # æƒé™å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ field/           # å­—æ®µè§£æå™¨
â”‚   â”œâ”€â”€ mapper/              # æ•°æ®è®¿é—®å±‚
â”‚   â””â”€â”€ service/             # æ•°æ®æºæœåŠ¡
â”œâ”€â”€ dataease/                 # DataEase BI é›†æˆ
â”‚   â”œâ”€â”€ constants/           # æ•°æ®èŒƒå›´å˜é‡
â”‚   â”œâ”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ service/             # DataEase æœåŠ¡
â”œâ”€â”€ dingtalk/                 # é’‰é’‰é›†æˆ
â”œâ”€â”€ lark/                     # é£ä¹¦é›†æˆ
â”œâ”€â”€ wecom/                    # ä¼ä¸šå¾®ä¿¡é›†æˆ
â”œâ”€â”€ sso/                      # å•ç‚¹ç™»å½•
â”œâ”€â”€ sync/                     # æ•°æ®åŒæ­¥
â””â”€â”€ common/                   # å…¬å…±ç»„ä»¶
    â”œâ”€â”€ client/              # HTTP å®¢æˆ·ç«¯
    â”œâ”€â”€ dto/                 # å…¬å…± DTO
    â””â”€â”€ utils/               # å·¥å…·ç±»
```

---

## ğŸš€ ä¹ã€AI èƒ½åŠ›æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„ AI æ™ºèƒ½ä½“

1. **åˆ›å»ºæ™ºèƒ½ä½“åº”ç”¨** - åœ¨ MaxKB å¹³å°åˆ›å»ºåº”ç”¨
2. **é…ç½®å·¥ä½œæµ** - å®šä¹‰æ™ºèƒ½ä½“çš„å¯¹è¯é€»è¾‘
3. **è·å– Access Token** - é€šè¿‡ API è·å–è®¿é—®ä»¤ç‰Œ
4. **åµŒå…¥ CRM** - ä½¿ç”¨åµŒå…¥è„šæœ¬é›†æˆåˆ° CRM ç•Œé¢

### æ‰©å±• SQLBot æ”¯æŒçš„è¡¨

```java
// 1. åœ¨ SQLBotTable æšä¸¾æ·»åŠ æ–°è¡¨
NEW_TABLE("table_name", "è¡¨æè¿°", PERMISSION_READ, true);

// 2. å®ç°å¯¹åº”çš„æƒé™å¤„ç†å™¨
public class NewTablePermissionHandler extends DataScopeTablePermissionHandler {
    @Override
    public void handleTable(TableDTO table, TableHandleParam param) {
        // å®ç°æƒé™è¿‡æ»¤é€»è¾‘
    }
}

// 3. åœ¨å·¥å‚ç±»æ³¨å†Œå¤„ç†å™¨
TablePermissionHandlerFactory.register(SQLBotTable.NEW_TABLE, new NewTablePermissionHandler());
```

### é›†æˆæ–°çš„ BI å·¥å…·

1. å®ç° JWT Token ç”Ÿæˆé€»è¾‘
2. é…ç½®åµŒå…¥å¼ iframe å‚æ•°
3. å®ç°ç”¨æˆ·/æƒé™åŒæ­¥æœºåˆ¶
4. å¤„ç†æ•°æ®èŒƒå›´å˜é‡æ˜ å°„

---

## ğŸ“Š åã€AI åŠŸèƒ½å¯¹ç…§è¡¨

| åŠŸèƒ½é¢†åŸŸ | åŠŸèƒ½ç‚¹ | æŠ€æœ¯å®ç° | çŠ¶æ€ |
|----------|--------|----------|------|
| **æ™ºèƒ½åˆ›å»º** | å¯¹è¯å¼åˆ›å»ºçº¿ç´¢ | MaxKB + MCP | âœ… å·²å®ç° |
| **æ™ºèƒ½åˆ›å»º** | å¯¹è¯å¼åˆ›å»ºå®¢æˆ· | MaxKB + MCP | âœ… å·²å®ç° |
| **æ™ºèƒ½åˆ›å»º** | å¯¹è¯å¼åˆ›å»ºå•†æœº | MaxKB + MCP | âœ… å·²å®ç° |
| **æ™ºèƒ½åˆ›å»º** | å¯¹è¯å¼åˆ›å»ºè”ç³»äºº | MaxKB + MCP | âœ… å·²å®ç° |
| **æ™ºèƒ½å½•å…¥** | è·Ÿè¿›è®°å½•æ™ºèƒ½å¡«å†™ | MaxKB | âœ… å·²å®ç° |
| **æ™ºèƒ½æŸ¥é‡** | å®¢æˆ·/çº¿ç´¢é‡å¤æ£€æµ‹ | MCP + æœç´¢æœåŠ¡ | âœ… å·²å®ç° |
| **æ™ºèƒ½é—®æ•°** | è‡ªç„¶è¯­è¨€æŸ¥è¯¢æ•°æ® | SQLBot | âœ… å·²å®ç° |
| **æ•°æ®å¯è§†åŒ–** | é”€å”®ä»ªè¡¨ç›˜ | DataEase | âœ… å·²å®ç° |
| **è‡ªåŠ¨åŒ–** | å•†æœºè‡ªåŠ¨å…³é—­è§„åˆ™ | è§„åˆ™å¼•æ“ | âœ… å·²å®ç° |
| **è‡ªåŠ¨åŒ–** | çº¿ç´¢/å®¢æˆ·è‡ªåŠ¨å›æ”¶ | è§„åˆ™å¼•æ“ | âœ… å·²å®ç° |
| **å…¨å±€æœç´¢** | è·¨æ¨¡å—ç»Ÿä¸€æœç´¢ | æœç´¢æœåŠ¡ | âœ… å·²å®ç° |
| **æ¶ˆæ¯é€šçŸ¥** | ä¼ä¸šå¾®ä¿¡/é’‰é’‰/é£ä¹¦ | å¹³å°é›†æˆ | âœ… å·²å®ç° |

---

## ğŸ“š ç›¸å…³èµ„æº

- **MaxKB æ™ºèƒ½ä½“å¹³å°**: https://github.com/1Panel-dev/MaxKB
- **SQLBot æ™ºèƒ½é—®æ•°**: https://github.com/dataease/SQLBot
- **DataEase BI å·¥å…·**: https://github.com/dataease/dataease
- **Cordys CRM æ–‡æ¡£**: https://cordys.cn/docs/

---

*æœ¬æ–‡æ¡£è¯¦ç»†æ¢³ç†äº† Cordys CRM çš„ AI é©±åŠ¨èƒ½åŠ›ï¼Œä¾›å¼€å‘è€…äº†è§£å’Œæ‰©å±•ä½¿ç”¨ã€‚*


# ============================================================================
# Cordys CRM - 发布工作流
#
# 触发条件：
#   - 创建 Release
#   - 手动触发
#
# 功能：
#   - 构建生产镜像
#   - 创建离线安装包
#   - 上传到 Release 资产
# ============================================================================

name: Release

on:
  release:
    types: [published]
  
  workflow_dispatch:
    inputs:
      tag:
        description: '发布版本标签 (如 v1.3.2)'
        required: true
      prerelease:
        description: '是否为预发布版本'
        type: boolean
        default: false

env:
  DOCKERHUB_REPO: 1panel/cordys-crm
  GHCR_REPO: ghcr.io/${{ github.repository }}

jobs:
  # ============================================================
  # 构建发布包
  # ============================================================
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 确定版本号
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION=${{ github.event.release.tag_name }}
          else
            VERSION=${{ github.event.inputs.tag }}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
      
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: 登录 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 构建并推送生产镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version_number }}
            ${{ env.DOCKERHUB_REPO }}:latest
            ${{ env.GHCR_REPO }}:${{ steps.version.outputs.version }}
            ${{ env.GHCR_REPO }}:latest
          build-args: |
            CRM_VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: 创建离线安装包 (amd64)
        run: |
          mkdir -p release
          
          # 拉取镜像
          docker pull --platform linux/amd64 ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version }}
          
          # 保存镜像
          docker save ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version }} | gzip > release/cordys-crm-${{ steps.version.outputs.version_number }}-amd64.tar.gz
          
          # 创建安装脚本
          cat > release/install.sh << 'EOF'
          #!/bin/bash
          set -e
          
          VERSION="${1:-latest}"
          IMAGE_FILE="cordys-crm-${VERSION}-amd64.tar.gz"
          
          echo "=========================================="
          echo "Cordys CRM 离线安装脚本"
          echo "版本: ${VERSION}"
          echo "=========================================="
          
          if [ -f "$IMAGE_FILE" ]; then
              echo "正在加载 Docker 镜像..."
              gunzip -c "$IMAGE_FILE" | docker load
          else
              echo "错误: 找不到镜像文件 $IMAGE_FILE"
              exit 1
          fi
          
          echo "正在启动 Cordys CRM..."
          docker run -d \
            --name cordys-crm \
            --restart unless-stopped \
            -p 8081:8081 \
            -p 8082:8082 \
            -v ~/cordys:/opt/cordys \
            1panel/cordys-crm:${VERSION}
          
          echo ""
          echo "=========================================="
          echo "Cordys CRM 安装完成！"
          echo "访问地址: http://localhost:8081"
          echo "默认账号: admin"
          echo "默认密码: CordysCRM"
          echo "=========================================="
          EOF
          
          chmod +x release/install.sh
          
          # 复制配置模板
          cp docker/env.template release/env.template
          cp docker/env.external.template release/env.external.template
          cp -r docker/conf release/ 2>/dev/null || true
          
          # 复制外部服务部署配置（方案3）
          cp docker/docker-compose.external.yml release/
          cp docker/docker-compose.traefik.yml release/
      
      - name: 创建离线安装包 (arm64)
        run: |
          # 拉取 arm64 镜像
          docker pull --platform linux/arm64 ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version }}
          
          # 保存镜像
          docker save ${{ env.DOCKERHUB_REPO }}:${{ steps.version.outputs.version }} | gzip > release/cordys-crm-${{ steps.version.outputs.version_number }}-arm64.tar.gz
      
      - name: 计算校验和
        run: |
          cd release
          sha256sum *.tar.gz > SHA256SUMS.txt
      
      - name: 上传发布资产
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'release'
        with:
          files: |
            release/cordys-crm-${{ steps.version.outputs.version_number }}-amd64.tar.gz
            release/cordys-crm-${{ steps.version.outputs.version_number }}-arm64.tar.gz
            release/install.sh
            release/env.template
            release/env.external.template
            release/docker-compose.external.yml
            release/docker-compose.traefik.yml
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: release/
          retention-days: 30

  # ============================================================
  # 更新文档
  # ============================================================
  update-docs:
    runs-on: ubuntu-latest
    needs: build-release
    if: github.event_name == 'release'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
      
      - name: 更新版本信息
        run: |
          VERSION=${{ github.event.release.tag_name }}
          echo "发布版本: ${VERSION}"
          # 可以在这里添加更新版本号的逻辑


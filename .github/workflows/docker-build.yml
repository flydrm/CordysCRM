# ============================================================================
# Cordys CRM - Docker é•œåƒæž„å»ºå·¥ä½œæµ
#
# åŠŸèƒ½ï¼šæž„å»ºå¹¶æŽ¨é€é•œåƒåˆ° GitHub Container Registry
# è§¦å‘ï¼šæŽ¨é€åˆ° main åˆ†æ”¯ã€åˆ›å»º Releaseã€æ‰‹åŠ¨è§¦å‘
# ============================================================================

name: Docker Build and Push

on:
  push:
    branches: [main]
    paths-ignore: ['**.md', 'docs/**']
  
  release:
    types: [published]
  
  workflow_dispatch:
    inputs:
      version:
        description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        default: 'latest'

env:
  IMAGE_REPO: ghcr.io/${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      tags: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ æž„å»ºç‰ˆæœ¬: ${VERSION}"
      
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_REPO }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short
      
      - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: CRM_VERSION=${{ steps.version.outputs.version }}
          no-cache: true
      
      # ============================================================
      # æž„å»ºå®ŒæˆåŽæ˜¾ç¤ºé•œåƒä¿¡æ¯
      # ============================================================
      - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºç»“æžœ
        run: |
          echo ""
          echo "=============================================="
          echo "ðŸŽ‰ Docker é•œåƒæž„å»ºæˆåŠŸï¼"
          echo "=============================================="
          echo ""
          echo "ðŸ“¦ é•œåƒç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "ðŸ·ï¸  é•œåƒæ ‡ç­¾:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | while read tag; do
            echo "   â€¢ ${tag}"
          done
          echo ""
          echo "ðŸ”— é•œåƒä»“åº“: https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')"
          echo ""
          echo "ðŸ“¥ å¿«é€Ÿæ‹‰å–å‘½ä»¤:"
          echo "   docker pull ${{ env.IMAGE_REPO }}:latest"
          echo "   docker pull ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}"
          echo ""
          echo "ðŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤:"
          echo "   docker run -d \\"
          echo "     --name cordys-crm \\"
          echo "     --restart unless-stopped \\"
          echo "     -p 8081:8081 \\"
          echo "     -p 8082:8082 \\"
          echo "     -v ~/cordys:/opt/cordys \\"
          echo "     ${{ env.IMAGE_REPO }}:latest"
          echo ""
          echo "=============================================="
      
      - name: ðŸ“ ç”Ÿæˆ Job Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ³ Docker é•œåƒæž„å»ºæˆåŠŸ
          
          ## ðŸ“¦ é•œåƒä¿¡æ¯
          
          | å±žæ€§ | å€¼ |
          |------|-----|
          | **ç‰ˆæœ¬** | \`${{ steps.version.outputs.version }}\` |
          | **ä»“åº“** | [\`${{ env.IMAGE_REPO }}\`](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]')) |
          | **å¹³å°** | \`linux/amd64\`, \`linux/arm64\` |
          | **æž„å»ºæ—¶é—´** | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |
          
          ## ðŸ·ï¸ é•œåƒæ ‡ç­¾
          
          \`\`\`
          ${{ steps.meta.outputs.tags }}
          \`\`\`
          
          ## ðŸ“¥ å¿«é€Ÿæ‹‰å–
          
          \`\`\`bash
          # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
          docker pull ${{ env.IMAGE_REPO }}:latest
          
          # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
          docker pull ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }}
          \`\`\`
          
          ## ðŸš€ å¿«é€Ÿå¯åŠ¨
          
          \`\`\`bash
          docker run -d \\
            --name cordys-crm \\
            --restart unless-stopped \\
            -p 8081:8081 \\
            -p 8082:8082 \\
            -v ~/cordys:/opt/cordys \\
            ${{ env.IMAGE_REPO }}:latest
          \`\`\`
          
          ## ðŸ”— ç›¸å…³é“¾æŽ¥
          
          - [é•œåƒä»“åº“](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2 | tr '[:upper:]' '[:lower:]'))
          - [éƒ¨ç½²æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/DEPLOYMENT.md)
          - [Docker é…ç½®](https://github.com/${{ github.repository }}/tree/main/docker)
          EOF

      # éªŒè¯é•œåƒå†…åŒ…å«å¯æ‰§è¡Œ JAR
      - name: âœ… Verify app.jar exists in image
        run: |
          docker run --rm ${{ env.IMAGE_REPO }}:${{ steps.version.outputs.version }} ls -l /app/app.jar

  # Release æ—¶åˆ›å»ºç¦»çº¿å®‰è£…åŒ…
  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    permissions:
      contents: write
      packages: read
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: åˆ›å»ºç¦»çº¿å®‰è£…åŒ…
        run: |
          mkdir -p release
          VERSION="${{ needs.build.outputs.version }}"
          
          # æ‹‰å–å¹¶ä¿å­˜é•œåƒ
          docker pull --platform linux/amd64 ${{ env.IMAGE_REPO }}:latest
          docker save ${{ env.IMAGE_REPO }}:latest | gzip > release/cordys-crm-${VERSION#v}-amd64.tar.gz
          
          docker pull --platform linux/arm64 ${{ env.IMAGE_REPO }}:latest
          docker save ${{ env.IMAGE_REPO }}:latest | gzip > release/cordys-crm-${VERSION#v}-arm64.tar.gz
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp docker/env.external.template release/ 2>/dev/null || true
          cp docker/docker-compose.external.yml release/ 2>/dev/null || true
          cp docker/docker-compose.traefik.yml release/ 2>/dev/null || true
          
          # æ ¡éªŒå’Œ
          cd release && sha256sum *.tar.gz > SHA256SUMS.txt
      
      - name: ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“ ç”Ÿæˆ Release Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“¦ ç¦»çº¿å®‰è£…åŒ…å·²åˆ›å»º
          
          | æ–‡ä»¶ | å¹³å° |
          |------|------|
          | \`cordys-crm-${{ needs.build.outputs.version }}-amd64.tar.gz\` | linux/amd64 |
          | \`cordys-crm-${{ needs.build.outputs.version }}-arm64.tar.gz\` | linux/arm64 |
          
          å·²ä¸Šä¼ åˆ° [Release é¡µé¢](https://github.com/${{ github.repository }}/releases)
          EOF
